#!/usr/bin/env ruby

require "yaml"

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

def password_arg(config)
  if config["password"]
    "-p#{config['password']}"
  end
end

def mysql_command(config)
  "mysql -u #{config['username']} #{password_arg(config)} -h #{config['host']}"
end

def database(config)
  "\`#{config['database']}\`"
end

YAML.load_file("../config/database.yml")["racing_on_rails"].each do |key, configs|
  %w{ development test }.each do |env|
    config = configs[env]
    system! "#{mysql_command(config)} -e 'drop database if exists \`#{config['database']}\`'"
    system! "#{mysql_command(config)} -e 'create database \`#{config['database']}\`'"
    system! "#{mysql_command(config)} --database=#{config['database']} < db/schema.sql"
    system! "#{mysql_command(config)} --database=#{config['database']} < db/#{key}.sql"
  end
end
