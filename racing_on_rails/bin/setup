#!/usr/bin/env ruby

require "erb"
require "yaml"

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

def database_config
  YAML.load(ERB.new(File.read("../config/database.yml")).result).select do |key, config|
    key["racing_on_rails"] && !key["racing_on_rails_default"]
  end
end

def password_arg(config)
  if config["password"]
    "-p#{config['password']}"
  end
end

def mysql_command(config)
  "mysql -u #{config['username']} #{password_arg(config)} -h #{config['host']}"
end

def database(config)
  "\`#{config['database']}\`"
end

database_config.each do |key, config|
  system! "#{mysql_command(config)} -e 'drop database if exists \`#{config['database']}\`'"
  system! "#{mysql_command(config)} -e 'create database \`#{config['database']}\`'"
  system! "#{mysql_command(config)} --database=#{config['database']} < db/schema.sql"

  if File.exist?("db/#{key}.sql")
    system! "#{mysql_command(config)} --database=#{config['database']} < db/#{key}.sql"
  end
end
