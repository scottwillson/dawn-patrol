#!/bin/bash
set -e

if [ "$(uname)" == "Darwin" ]; then
  brew --version >/dev/null 2>&1 || { echo "Install Homebrew or docker and git manually"; exit 1;}
  docker-compose -v >/dev/null 2>&1 || { brew install docker-compose; }
elif [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
  docker-compose -v >/dev/null 2>&1 || { sudo apt-get -y install docker-compose; }
fi

echo "Stop and remove containers"
docker-compose -f docker-compose-test.yml stop
docker-compose -f docker-compose-test.yml rm -f
docker-compose stop
docker-compose rm -f
rm -rf web/build
rm -rf web/node_modules

echo "Run tests"
./bin/test

echo "Stop and remove test containers"
docker-compose -f docker-compose-test.yml stop
docker-compose -f docker-compose-test.yml rm -f

echo "Build and start deploy containers"
docker-compose -f docker-compose-deploy.yml build
docker-compose -f docker-compose-deploy.yml up -d api db web

echo "Run E2E tests"
e2e-test/bin/test.sh

echo "Stop deploy containers"
docker-compose -f docker-compose-deploy.yml stop

echo "Dev up"
bin/dev.sh
